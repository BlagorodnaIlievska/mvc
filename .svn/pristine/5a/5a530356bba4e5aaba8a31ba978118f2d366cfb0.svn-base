function vf_dp_napolnilista(){
    var oddel = jQuery(".firmadropdown").val();
    jQuery.ajax({
        url:"/index.php/vlezni_fakturi/pregled_vlezni/getVlezniFakturi",
        type:'POST',
        data: {oddel: oddel},
        dataType:'json',
        success:function (response) {
//            console.log(response);
            jQuery(".tvleznifakturi tbody tr").removeClass("active");
            jQuery(".tvleznifakturi tbody").find("tr:gt(1)").remove();
            var tr = jQuery('.tvleznifakturi tr:last');
            tr.removeClass('hiderow');
            var osnovasum = 0;
            var vkupnoddv = 0;
            var vkupnovkupno = 0;
            var vkupnostavki = response.length;
            var valutisum = new Object;
            valutisum.mkd = new Object;
            for (var i = 0; i < response.length; i++) {
                var dokumentihtml="";
                var newrow = jQuery(tr).clone().insertAfter(tr);
                newrow.attr("fakturaid", response[i].dbid);
                newrow.find('.katbroj').html(response[i].katbroj);
                newrow.find('.broj').html(response[i].broj);
                newrow.find('.datum').html(response[i].datum);
                newrow.find('.klient').html(response[i].firmaIme);
                newrow.find('.osnova').html(formatnumbermkd(response[i].osnova));
                newrow.find('.ddv').html(formatnumbermkd(response[i].ddv));
                newrow.find('.vkupno').html(formatnumbermkd(response[i].vkupno));
                newrow.find('.odel').html(response[i].zadolzen_oddel);
                for (var ib=0 ; ib < response[i].dokumenti.length;ib++){
                    dokumentihtml=dokumentihtml+
                       '<span>'+response[i].dokumenti[ib].textBroj+'</span>';
                }
                newrow.find('.zabeleska').html(dokumentihtml);
                if(response[i].valuta == 0){
                    newrow.find('.valuta').text("ден");

                } else if (response[i].valuta == 1){
                    newrow.find('.valuta').text("усд");
                } else if(response[i].valuta == 2) {
                    newrow.find('.valuta').text("еур");
                }

                osnovasum =1 * osnovasum + 1 * response[i].osnova;
                vkupnoddv = 1 * vkupnoddv + 1 * response[i].ddv;
                vkupnovkupno =1 * vkupnovkupno + 1 * response[i].vkupno;
            }
            tr.addClass('hiderow');
            jQuery(".sumiranje .osnovasum").html(formatnumbermkd(osnovasum));
            jQuery(".sumiranje .vkupnoddv").html(formatnumbermkd(vkupnoddv));
            jQuery(".sumiranje .vkupnovkupno").html(formatnumbermkd(vkupnovkupno));
            jQuery(".tvleznifakturi .vkupnostavki").html(vkupnostavki + " во листа");
            jQuery(".naslovvleznifakturi .vkupnostavki").html(vkupnostavki);
            jQuery(".tvleznifakturi").trigger("update");
            //bind the delete event
            jQuery('.tvleznifakturi tbody .deletefaktura').click(function() {
                var trow = jQuery(this).closest('tr');
                var fakturaid = trow.attr('fakturaid');
                delete_vf(fakturaid);
            });
            jQuery(".tvleznifakturi tbody .editfaktura").click(function () {
                editfaktura(jQuery(this).parent());
            });
            jQuery(".tvleznifakturi tbody .infofaktura").click(function () {
                vf_info(jQuery(this).parent());
            });
        }
    });
}
function site_vlezni_fakturi(){
    jQuery.ajax({
        url:"/index.php/vlezni_fakturi/pregled_vlezni/site_vlezni",
        type:'POST',
        dataType:'json',
        success:function (response) {
            //console.log(response);
            jQuery(".tabela-fakturi tbody").html('');

            jQuery.each(response, function (index, item) {
                //  console.log(item);

                jQuery(".tabela-fakturi tbody").append(('<tr fakturaid="' + item.fakturaid + '">' +
                    '<td><input type="checkbox" name="cekirano" class="cekirano" value="'+item.fakturaid+'"></td>' +
                    '<td>' + item.broj + '</td>' +
                    '<td>' + item.datum + '</td>' +
                    '<td>' + item.firma + '</td>' +
                    '<td>' + item.zadolzen_oddel + '</td>' +
                    '<td>' + item.vkupno + '</td>' +
                    '<td>' + item.zabeleska + '</td>' +

                    '</tr>'
                    ));
            });

            jQuery(".tabela-fakturi").trigger("update");


        }
    });
}
  function proveri_dali_ja_ima_fakturata(id){
      var id=id;
      jQuery.ajax({
          url:"/index.php/vlezni_fakturi/pregled_vlezni/proveri_dali_ja_ima_fakturata?id="+id,
          type:'POST',
          dataType:'json',
          success:function (response) {

             console.log('test');

          }
      });
  }
function editfaktura(data) {

    var id = jQuery(data).attr('fakturaid');

    var formaction = "/index.php/vlezni_fakturi/pregled_vlezni/editVleznaFaktura?id=" + id;
    var tempdialog = "dialog" + Math.floor((Math.random() * 1000) + 1);

    jQuery.ajax({
        url:formaction,
        success:function (response) {
//            console.log(response);
            jQuery("body").append('<div class="' + tempdialog + '"></div>');
            jQuery("." + tempdialog).html(response);
            jQuery('div.' + tempdialog).dialog({
                autoOpen:true,
                width:1024,
                position:[00, 00],
                modal:true,
                title:"Измени влезна фактура",
                dialogClass: 'dialogsotabovi',
                close:function (event, ui) {
                    jQuery(this).dialog("destroy");
                    jQuery(this).remove();
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/editFaktura?id='+id,
                type:'GET',
                success:function (response) {
                    jQuery("." + tempdialog +" #editfaktura").html(response);
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/editUplata?id='+id,
                type:'GET',
                success:function (response) {

                    jQuery("." + tempdialog +" #edituplata").html(response);
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/editPriemnica?id='+id,
                type:'GET',
                success:function (response) {

                    jQuery("." + tempdialog +" #editpriemnici").html(response);
                }
            });
            jQuery("." + tempdialog + ' .pop-menu-tabs').tabs({
                cache:true,
                ajaxOptions:{
                    type:"POST"
                }
            });
        }
    });
}

function nova_vlezna_faktura(){
    var formaction = '/index.php/vlezni_fakturi/pregled_vlezni/nova_faktura';
    var tempdialog = "dialog" + Math.floor((Math.random() * 1000) + 1);
    jQuery.ajax({
        url:formaction,
        success:function (response) {
            jQuery("body").append('<div class="' + tempdialog + '"></div>');
            jQuery("." + tempdialog).html(response);
            jQuery('div.' + tempdialog).dialog({
                autoOpen:true,
//                width:"auto",
                width:1024,
                position:[00, 00],
                modal:true,
                dialogClass: 'dialogsotabovi',
                title:"Нова влезна Фактура",
                close:function (event, ui) {
                    jQuery(this).dialog("destroy");
                    jQuery(this).remove();
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/index',
                type:'GET',
                success:function (response) {
                    jQuery("." + tempdialog +" #faktura").html(response);
                }
            });
            jQuery("." + tempdialog + ' .pop-menu-tabs').tabs({
                cache:true,
                ajaxOptions:{
                    type:"POST"
                }
            });
        }
    });
}

function vf_info(data) {
    var id = jQuery(data).attr('fakturaid');
    //console.log(id);
    var formaction = "/index.php/vlezni_fakturi/pregled_vlezni/editVleznaFaktura?id=" + id;
    var tempdialog = "dialog" + Math.floor((Math.random() * 1000) + 1);

    jQuery.ajax({
        url:formaction,
        success:function (response) {
            jQuery("body").append('<div class="' + tempdialog + '"></div>');
            jQuery("." + tempdialog).html(response);


            jQuery('div.' + tempdialog).dialog({
                autoOpen:true,
                width:1024,
                position:[00, 00],
                modal:true,
                title:"Инфо влезна фактура",
                dialogClass: 'dialogsotabovi',
                close:function (event, ui) {
                    // Remove the dialog elements
                    // Note: this will put the original div element in the dom
                    jQuery(this).dialog("destroy");
                    // Remove the left over element (the original div element)
                    jQuery(this).remove();
                }
                //buttons:{ "Close": function() { jQuery(this).dialog('destroy'); } }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/editFaktura?id='+id,
                type:'GET',
                success:function (response) {

                    jQuery("." + tempdialog +" #editfaktura").html(response);
                    jQuery('div.' + tempdialog+ ' #editfaktura input').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editfaktura textarea').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editfaktura select').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editfaktura .fakturaklient').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editfaktura .izborkonto').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editfaktura button').remove();
                    jQuery('div.' + tempdialog+ ' #edit_faktura_form').addClass("info-vlezna-faktura");
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/editUplata?id='+id,
                type:'GET',
                success:function (response) {

                    jQuery("." + tempdialog +" #edituplata").html(response);
                    jQuery('div.' + tempdialog+ ' #edituplata input').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #edituplata textarea').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #edituplata select').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #edituplata button').remove();
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/faktura/editPriemnica?id='+id,
                type:'GET',
                success:function (response) {

                    jQuery("." + tempdialog +" #editpriemnici").html(response);
                    jQuery('div.' + tempdialog+ ' #editpriemnici input').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editpriemnici textarea').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editpriemnici select').attr("disabled","disabled");
                    jQuery('div.' + tempdialog+ ' #editpriemnici button').remove();
                }
            });
            jQuery("." + tempdialog + ' .pop-menu-tabs').tabs({
                cache:true,
                ajaxOptions:{
                    type:"POST"
                }
            });
        }
    });
}

function presmetajSuma(param)
{
    var currentrow = param.closest('tr');
    var kolicina = currentrow.find("input.kolicina").val();
    var cenabezddvtemp = formatbrojjs(currentrow.find("input.bezddv").val());
    var cenabezddv = formatbrojjs(currentrow.find("input.bezddv").val());
    var ddv = formatbrojjs(parseInt(currentrow.find(".ddvid").val()));
    var vkupnobezddv = kolicina * cenabezddv;
    var cenasoddv = cenabezddv + (cenabezddv*ddv)/100;
    var vkupnoddv = (vkupnobezddv*ddv)/100;

    var vkupnosoddv = vkupnobezddv + vkupnoddv;
    // console.log(vkupnoddv);
    currentrow.find(".vkupno1").val(formatnumbermkd(vkupnobezddv));
    currentrow.find(".soddv").val(formatnumbermkd(cenasoddv));
    currentrow.find(".vkupnoddv").val(formatnumbermkd(vkupnoddv));
    currentrow.find(".vkupno2").val(formatnumbermkd(vkupnosoddv));
    currentrow.find(".bezddv").val(formatnumbermkd(cenabezddvtemp));
    presmetajSumaStavkiVleznaFaktura();
}
function presmetajSumaBezDDV(param)
{
    var currentrow = param.closest('tr');
    var kolicina = formatbrojjs(currentrow.find("input.kolicina").val());
    var cenabezddv = formatbrojjs(currentrow.find("input.bezddv").val());
    var vkupnobezddv = kolicina * cenabezddv;
    currentrow.find(".vkupno1").val(formatnumbermkd(vkupnobezddv));
//    presmetajSumaStavkiVleznaFaktura();
}

function presmetajSumaPoRed(param)
{
    var currentrow = param;
    var kolicina = currentrow.find("input.kolicina").val();
    //currentrow.find("input.kolicina").disable();
    var cenabezddv = formatbrojjs(currentrow.find("input.bezddv").val());
    var ddv = currentrow.find(".ddvid").val();
    var vkupnobezddv = kolicina * cenabezddv;
    var cenasoddv = cenabezddv + (cenabezddv*ddv)/100;
    var vkupnoddv = (vkupnobezddv*ddv)/100;
    var vkupnosoddv = vkupnobezddv + vkupnoddv;
    currentrow.find(".vkupno1").val(formatnumbermkd(vkupnobezddv));
    currentrow.find(".soddv").val(formatnumbermkd(cenasoddv));
    currentrow.find(".vkupnoddv").val(formatnumbermkd(vkupnoddv));
    currentrow.find(".vkupno2").val(formatnumbermkd(vkupnosoddv));
    presmetajSumaStavkiVleznaFaktura();
}

function presmetajSumaStavkiVleznaFaktura()
{
        var ddvsum5 = 0, ddvsum18 = 0, osnovasum = 0, vkupnosum = 0;
        jQuery(".tstavki tbody tr").each(function() {
            var osnova = formatbrojjs(jQuery(this).find('.vkupno1').val());
            var ddvprocent = parseInt(jQuery(this).find('.ddvid').val());
            var ddv = formatbrojjs(jQuery(this).find('.vkupnoddv').val());
            var vkupno = formatbrojjs(jQuery(this).find('.vkupno2').val());
            if(osnova.length != 0) {
                osnovasum += parseFloat(osnova);
            }
            if(ddvprocent == 5)
            {
                if(ddv.length != 0) {
                    ddvsum5 += parseFloat(ddv);
                }
            }
            else if(ddvprocent == 18)
            {
                if(ddv.length != 0) {
                    ddvsum18 += parseFloat(ddv);
                }
            }
            if(vkupno.length != 0) {
                vkupnosum += parseFloat(vkupno);
            }
        });
        jQuery('.tvkupen-iznos-novafak').find('.vkupnoddv5').html(formatnumbermkd(ddvsum5));
        jQuery('.tvkupen-iznos-novafak').find('.vkupnoddv18').html(formatnumbermkd(ddvsum18));
        jQuery('.tvkupen-iznos-novafak').find('.vkupnoosnova').html(formatnumbermkd(osnovasum));
        console.log(vkupnosum);
        jQuery('.tvkupen-iznos-novafak').find('.vkupnoddv').html(formatnumbermkd(vkupnosum));
        jQuery('.fakturaddv5').val(ddvsum5);
        jQuery('.fakturaddv18').val(ddvsum18);
        jQuery('.osnova').val(osnovasum);
        jQuery('.vkupnose').val(vkupnosum);
}

//function getPodatociArtiklByStavka(stavka, elem)
//{
//    var data = {
//        stavka: stavka,
//        katbroj: ''
//    }
//    jQuery.ajax({
//        url:"/index.php/vlezni_fakturi/faktura/getPodatociArtikl",
//        type:'POST',
//        data: data,
//        dataType:'json',
//        success:function (response) {
////            console.log(response);
//            var currentrow = elem.closest('tr');
//            currentrow.find("td.katbroj .ui-combobox-input").val(response[0].sifra2);
//            currentrow.find("td.edmerka .ui-combobox-input").val(response[0].EdMerkaID);
//            currentrow.find(".edmerkaid").val(response[0].EdMerkaID);
//            currentrow.find("td.ddv .ui-combobox-input").val(response[0].ddv);
//            currentrow.find(".ddvid").val(response[0].ddv);
//            currentrow.find(".sifra").val(response[0].sifra1);
//            currentrow.find(".stavka").val(response[0].stavka);
//            currentrow.find(".kontoid").val(response[0].kontoID);
//            currentrow.find(".konto").html(response[0].kontoSifra);
//            addNewStavkaVleznaFaktura(currentrow);
//        }
//    });
//}
//function getPodatociArtiklByKatBroj(katbroj, elem)
//{
//    var data = {
//        stavka: 0,
//        katbroj: katbroj
//    }
//    jQuery.ajax({
//        url:"/index.php/vlezni_fakturi/faktura/getPodatociArtikl",
//        type:'POST',
//        data: data,
//        dataType:'json',
//        success:function (response) {
////            console.log(response);
//            var currentrow = elem.closest('tr');
//            currentrow.find("td.artikli .ui-combobox-input").val(response[0].stavka);
//            currentrow.find(".edmerka").html(response[0].EdMerkaIme);
//            currentrow.find(".edmerkaid").val(response[0].EdMerkaID);
//            currentrow.find(".ddv").html(response[0].ddv);
//            currentrow.find(".ddvid").val(response[0].ddv);
//            currentrow.find(".sifra").val(response[0].sifra1);
//            currentrow.find(".stavka").val(response[0].stavka);
//            currentrow.find(".kontoid").val(response[0].kontoID);
//            currentrow.find(".konto").html(response[0].kontoSifra);
//            addNewStavkaVleznaFaktura(currentrow);
//        }
//    });
//}
//function addNewStavkaVleznaFaktura(currentrow)
//{
//    if(currentrow.is(":last-child"))
//    {
//        if(jQuery('.checkkonto').is(':checked')) var status='';
//        else var status='hide';
//        var lastnum = jQuery('.tstavki tr:last').find('.number').text();
//        if(lastnum.length > 0) var newnum = parseInt(lastnum) + parseInt(1);
//        else var newnum = 1;
//        jQuery(".tstavki tbody").append(('<tr class="detali trow">' +
//            '<td>' + '<img class="delete" width="15" height="15" alt="" src="/images/delete.png">' +'</td>' +
//            '<td class="number">' + newnum +  '</td>' +
//            '<td class="katbroj">' + '<select class="katbroj-dropdown kat-drop-'+newnum+'" name="katbroj"></select>' + '</td>' +
//            '<td class="artikli">' + '<select class="artikli-dropdown art-drop-'+newnum+'" name="artikli"></select>' + '</td>' +
//            '<td class="konto">' + '</td>' +
//            '<td>' + '<input type="text" class="kolicina" name="kolicina" />' + '</td>' +
//            '<td>' + '<input type="text" class="koeficient" name="koeficient" value="1" />' + '</td>' +
//            '<td class="edmerka">'+ '</td>' +
//            '<td>' + '<input type="text" class="bezddv" name="bezddv" />' + '</td>' +
//            '<td>' + '<input type="text" class="vkupno1" name="vkupno1" readonly />' + '</td>' +
//            '<td class="ddv">' + '</td>' +
//            '<td>' + '<input type="text" class="vkupnoddv" name="vkupnoddv" readonly />' + '</td>' +
//            '<td>' + '<input type="text" class="vkupno2" name="vkupno2" readonly />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="sifra" name="sifra" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="stavka" name="stavka" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="kontoid" name="kontoid" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="edmerkaid" name="edmerkaid" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="ddvid" name="ddvid" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="tipstavka" name="tipstavka" value="1" />' + '</td>' +
//            '</tr>'
//            ));
//        jQuery.ajax({
//            url:  "/index.php/vlezni_fakturi/faktura/getArtikliDropdown",
//            type: 'GET',
//            dataType: 'json',
//            success: function (response) {
//                jQuery('.tstavki tr:last .artikli-dropdown').append('<option value=""></option>');
//                for(var i = 0; i < response.length;i++)
//                {
//                    jQuery('.tstavki tr:last .artikli-dropdown').append('<option value="'+response[i].SID+'">'+response[i].S1Ime+'</option>')
//                }
//                jQuery('.tstavki tr:last .artikli-dropdown').val();
//                var klasa = 'art-drop-'+newnum;
////                jQuery('.'+klasa).combobox();
//            }
//        });
//        jQuery.ajax({
//            url:  "/index.php/vlezni_fakturi/faktura/getKatbrojDropdown",
//            type: 'GET',
//            dataType: 'json',
//            success: function (response) {
//                for(var i = 0; i < response.length;i++)
//                {
//                    jQuery('.tstavki tr:last .katbroj-dropdown').append('<option value="'+response[i].sifra+'">'+response[i].sifra+'</option>')
//                }
//                jQuery('.tstavki tr:last .katbroj-dropdown').val();
//                var klasa2 = 'kat-drop-'+newnum;
////                jQuery('.'+klasa2).combobox();
//            }
//        });
//        jQuery('.artikli-dropdown').combobox();
//        jQuery('.katbroj-dropdown').combobox();
//    }
//}
function addNewStavkaVleznaFaktura2(currentrow)
{
    if(jQuery('.checkkonto').is(':checked')) var status='';
    else var status='hide';
    var checkartikl = jQuery('.tstavki tbody tr:last').find("td.artikli .ui-combobox-input").val();
    if(typeof checkartikl == "undefined") checkartikl = "temp";
    if(checkartikl.length == 0) jQuery('.tstavki tbody tr:last').remove();
        var lastnum = jQuery('.tstavki tr:last').find('.number').text();
        if(lastnum.length > 0) var newnum = parseInt(lastnum) + parseInt(1);
        else var newnum = 1;
        jQuery(".tstavki tbody").append(('<tr class="detali trow">' +
            '<td>' + '<img class="delete" width="15" height="15" alt="" src="/images/delete.png">' +'</td>' +
            '<td class="number">' + newnum +  '</td>' +
            '<td class="katbroj">' + '<select class="katbroj-dropdown" name="katbroj"></select>' + '</td>' +
            '<td class="artikli">' + '<select class="artikli-dropdown" name="artikli"></select>' + '</td>' +
            '<td class="konto">' + '</td>' +
            '<td>' + '<input type="text" class="kolicina" name="kolicina" />' + '</td>' +
            '<td>' + '<input type="text" class="koeficient" name="koeficient" value="1" />' + '</td>' +
            '<td class="edmerka">'+ currentrow.find('.EdMerka').text() + '</td>' +
            '<td>' + '<input type="text" class="bezddv" name="bezddv" />' + '</td>' +
            '<td>' + '<input type="text" class="vkupno1" name="vkupno1" />' + '</td>' +
//            '<td>' + '<input type="text" class="ddv" name="ddv" readonly />' + currentrow.find('.ddv').text() + '</td>' +
            '<td class="ddv">' + currentrow.find('.ddv').text() + '</td>' +
            '<td>' + '<input type="text" class="vkupnoddv" name="vkupnoddv" />' + '</td>' +
            '<td>' + '<input type="text" class="vkupno2" name="vkupno2" />' + '</td>' +
            '<td class="hide">' + '<input type="hidden" class="sifra" name="sifra"  value="' + currentrow.find('.sifra').text() +'" />' + '</td>' +
            '<td class="hide">' + '<input type="hidden" class="stavka" name="stavka" value="' + currentrow.find('.S1Ime').text() +'" />' + '</td>' +
            '<td class="hide">' + '<input type="hidden" class="kontoid" name="kontoid" />' + '</td>' +
            '<td class="hide">' + '<input type="hidden" class="edmerkaid" name="edmerkaid"  value="' + currentrow.find('.EdMerkaID').text() +'" />' + '</td>' +
            '<td class="hide">' + '<input type="hidden" class="ddvid" name="ddvid"  value="' + currentrow.find('.ddv').text() +'" />' + '</td>' +
            '<td class="hide">' + '<input type="hidden" class="tipstavka" name="tipstavka" value="1" />' + '</td>' +
            '</tr>'
            ));
        jQuery.ajax({
            url:  "/index.php/vlezni_fakturi/faktura/getArtikliDropdown",
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                for(var i = 0; i < response.length;i++)
                {
                    jQuery('.tstavki tr:last .artikli-dropdown').append('<option value="'+response[i].SID+'">'+response[i].S1Ime+'</option>')
                }
                jQuery('.artikli-dropdown').val();
            }
        });
        jQuery.ajax({
            url:  "/index.php/vlezni_fakturi/faktura/getKatbrojDropdown",
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                for(var i = 0; i < response.length;i++)
                {
                    jQuery('.tstavki tr:last .katbroj-dropdown').append('<option value="'+response[i].sifra+'">'+response[i].sifra+'</option>')
                }
                jQuery('.katbroj-dropdown').val();
            }
        });
//    jQuery.ajax({
//        url:  "/index.php/vlezni_fakturi/faktura/getKontoDropdown",
//        type: 'GET',
//        dataType: 'json',
//        success: function (response) {
//            for(var i = 0; i < response.length;i++)
//            {
//                jQuery('.tstavki tr:last').prev().find('.kontostavka').append('<option value="'+response[i].id+'">'+response[i].sifra+'</option>');
//            }
//            jQuery('.tstavki tr:last').prev().find('kontostavka').val();
////            jQuery('.tstavki tr:last').find('kontostavka').val('');
//        }
//    });
        jQuery('.artikli-dropdown').combobox();
        jQuery('.katbroj-dropdown').combobox();
        jQuery(".tstavki tr:last td.artikli .ui-combobox-input").val(currentrow.find('.S1Ime').text());
        jQuery(".tstavki tr:last td.katbroj .ui-combobox-input").val(currentrow.find('.katBroj').text());
        jQuery(".tstavki tr:last .ddv").val(currentrow.find('.ddv').text());
        var lastrow = jQuery('.tstavki tbody tr:last');
        addNewStavkaVleznaFaktura(lastrow);
}
//function addNewUslugaVleznaFaktura()
//{
//        if(jQuery('.checkkonto').is(':checked')) var status='';
//        else var status='hide';
//        var lastnum = jQuery('.tstavki tr:last').find('.number').text();
//        if(lastnum.length > 0) var newnum = parseInt(lastnum) + parseInt(1);
//        else var newnum = 1;
//        jQuery(".tstavki tbody").append(('<tr class="detali trow">' +
//            '<td>' + '<img class="delete" width="15" height="15" alt="" src="/images/delete.png">' +'</td>' +
//            '<td class="number">' + newnum +  '</td>' +
//            '<td class="katbroj">' + '<input class="katbroj" name="katbroj" />' + '</td>' +
//            '<td class="artikli">' + '<input class="artikli" name="artikli" />' + '</td>' +
//            '<td class="kontodetali">' + '<select class="kontostavka" name="kontostavka"></select>' + '</td>' +
//            '<td>' + '<input type="text" class="kolicina" name="kolicina" />' + '</td>' +
//            '<td>' + '<input type="text" class="koeficient" name="koeficient" value="1" />' + '</td>' +
//            '<td class="edmerka">'+ '<select class="edmerka-dropdown" name="edmerka"></select>' + '</td>' +
//            '<td>' + '<input type="text" class="bezddv" name="bezddv" />' + '</td>' +
//            '<td>' + '<input type="text" class="vkupno1" name="vkupno1" readonly />' + '</td>' +
////            '<td>' + '<input type="text" class="ddv" name="ddv" readonly />' + '</td>' +
//            '<td class="ddv">' + '<input type="text" class="ddv" name="ddv" />' + '</td>' +
//            '<td>' + '<input type="text" class="vkupnoddv" name="vkupnoddv" readonly />' + '</td>' +
//            '<td>' + '<input type="text" class="vkupno2" name="vkupno2" readonly />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="sifra" name="sifra" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="stavka" name="stavka" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="kontoid" name="kontoid" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="edmerkaid" name="edmerkaid" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="ddvid" name="ddvid" />' + '</td>' +
//            '<td class="hide">' + '<input type="hidden" class="tipstavka" name="tipstavka" value="2" />' + '</td>' +
//            '</tr>'
//            ));
//        jQuery.ajax({
//            url:  "/index.php/vlezni_fakturi/faktura/getEdMerkiDropdown",
//            type: 'GET',
//            dataType: 'json',
//            success: function (response) {
//                jQuery('.tstavki tr .edmerka-dropdown').append('<option value="0">'+'</option')
//                for(var i = 0; i < response.length;i++)
//                {
//                    jQuery('.tstavki tr .edmerka-dropdown').append('<option value="'+response[i].id+'">'+response[i].ime_dolgo+'</option>')
//                }
//                jQuery('.tstavki tr:last .ddv').val();
//            }
//        });
//        jQuery.ajax({
//            url:  "/index.php/vlezni_fakturi/faktura/getKontoDropdown",
//            type: 'GET',
//            dataType: 'json',
//            success: function (response) {
//                for(var i = 0; i < response.length;i++)
//                {
//                    jQuery('.tstavki tr:last .kontostavka').append('<option value="'+response[i].id+'">'+response[i].sifra+'</option>')
//                }
//                jQuery('.tstavki tr:last .kontostavka').val();
//            }
//        });
//    jQuery(".tstavki tbody input.ddv").blur(function () {
//        var temp = jQuery(this);
//        var currentrow = temp.closest('tr');
//        currentrow.find("input.ddvid").val(temp.val());
//        var kolicina = currentrow.find("input.kolicina").val();
//        var bezddv = currentrow.find("input.bezddv").val();
//        if (temp.val() && kolicina && bezddv) presmetajSuma(temp);
//    });
//    jQuery(".tstavki tbody select.edmerka-dropdown").change(function () {
//        var temp = jQuery(this);
//        var currentrow = temp.closest('tr');
//        currentrow.find("input.edmerkaid").val(temp.val());
//    });
//    jQuery(".tstavki tbody select.kontostavka").change(function () {
//        var temp = jQuery(this);
//        var currentrow = temp.closest('tr');
//        currentrow.find("input.kontoid").val(temp.val());
//    });
//    jQuery(".tstavki tbody input.katbroj").blur(function () {
//        var sifra = jQuery(this).val();
//        var currentrow = jQuery(this).closest("tr");
//        currentrow.find("input.sifra").val(sifra);
//    });
//    jQuery(".tstavki tbody input.artikli").blur(function () {
//        var usluga = jQuery(this).val();
//        var currentrow = jQuery(this).closest("tr");
//        currentrow.find("input.stavka").val(usluga);
////        console.log(currentrow.next().length);
//        addNewStavkaVleznaFaktura(currentrow);
//    });
//}
//function povrziPriemnicaVleznaFaktura(response)
//{
//console.log(response)
//    var kolicina = response.kolicina;
////    var cenabezddv = response.cenabezddv;
//    var ddv = response.ddv;
//    var vleznacena = response.vleznacena;
//    var vkupno = parseInt(vleznacena) * parseInt(kolicina);
//    var sevkupno = parseInt(vleznacena) * parseInt(kolicina);
//
//    if(jQuery('.checkkonto').is(':checked')) var status='';
//    else var status='hide';
//    var checkartikl = jQuery('.tstavki tbody tr:last').find("td.artikli .ui-combobox-input").val();
//    if(typeof checkartikl == "undefined") checkartikl = "temp";
//    if(checkartikl.length == 0) jQuery('.tstavki tbody tr:last').remove();
//    var lastnum = jQuery('.tstavki tr:last').find('.number').text();
//    if(lastnum.length > 0) var newnum = parseInt(lastnum) + parseInt(1);
//    else var newnum = 1;
//    jQuery(".tstavki tbody").append(('<tr class="detali trow">' +
//        '<td>' + '<img class="delete" width="15" height="15" alt="" src="/images/delete.png">' +'</td>' +
//        '<td class="number">' + newnum +  '</td>' +
//        '<td>' + '<input type="text" class="katbroj" name="katbroj" readonly value="' + response.sifra2 +'" />' + '</td>' +
//        '<td>' + '<input type="text" class="artikli" name="artikli" readonly value="' + response.stavka +'" />' + '</td>' +
//        '<td class="kontodetali">' + '<select class="kontostavka" name="kontostavka"></select>' + '</td>' +
//        '<td>' + '<input type="text" class="kolicina" name="kolicina"  value="' + kolicina +'" />' + '</td>' +
//        '<td class="edmerka">' +  response.edMerkaIme + '</td>' +
//        '<td>' + '<input type="text" class="bezddv" name="bezddv" value="' + vleznacena + '" />' + '</td>' +
//        '<td>' + '<input type="text" class="vkupno1" name="vkupno1" value="' + vkupno + '" />' + '</td>' +
//        '<td class="ddv">' + response.ddv + '</td>' +
//        '<td>' + '<input type="text" class="vkupnoddv" name="vkupnoddv" value="' + vleznacena + '" />' + '</td>' +
//        '<td>' + '<input type="text" class="vkupno2" name="vkupno2" value="' + sevkupno + '" />' + '</td>' +
//        '<td class="hide">' + '<input type="hidden" class="sifra" name="sifra"  value="' + response.sifra +'" />' + '</td>' +
//        '<td class="hide">' + '<input type="hidden" class="stavka" name="stavka" value="' + response.stavka +'" />' + '</td>' +
//        '<td class="hide">' + '<input type="hidden" class="idpriemnica" name="idpriemnica"  value="' + response.dbid +'" />' + '</td>' +
//        '<td class="hide">' + '<input type="hidden" class="edmerkaid" name="edmerkaid"  value="' + response.edMerkaID +'" />' + '</td>' +
//        '<td class="hide">' + '<input type="hidden" class="ddvid" name="ddvid"  value="' + response.ddv +'" />' + '</td>' +
//        '</tr>'
//        ));
//    jQuery.ajax({
//        url:  "/index.php/vlezni_fakturi/faktura/getKontoDropdown",
//        type: 'GET',
//        dataType: 'json',
//        success: function (response) {
//            for(var i = 0; i < response.length;i++)
//            {
//                jQuery('.kontostavka').append('<option value="'+response[i].id+'">'+response[i].sifra+'</option>')
//            }
//            jQuery('.kontostavka').val();
//        }
//    });
//    var lastrow = jQuery('.tstavki tbody tr:last');
////    presmetajSumaPoRed(lastrow);
//    presmetajSumaStavkiVleznaFaktura();
//    addNewStavkaVleznaFaktura(lastrow);
//}
function delete_vf(fakturaid){
    var r=confirm("Избриши фактура");
    if (r==true)
    {
        var b=confirm("Дали сте сигурни?");
        if (b==true)
        {
            var formurl = "/index.php/vlezni_fakturi/faktura/deleteFaktura";
            var data = {  id:fakturaid  }
            jQuery.ajax({
                url:formurl,
                type:'GET',
                data:data,
                success:function (response) {
                    vf_dp_napolnilista();
                    jQuery(".vlez-form .tstavkadetail tr:gt(1)").remove();
                }
            });
            vf_dp_napolnilista();
        }
    }
}
function getNewVleznaFakturaBroj(){
    var formaction = '/index.php/vlezni_fakturi/faktura/getLastVFBroj';
    jQuery.ajax({
        url:formaction,
        dataType: "json",
        success:function (response) {
            var lastbroj = response;
            var newbroj = 1*lastbroj + 1;
            var newbrojint = newbroj;
            var prefix = 'ВФ';
            var currentYear = (new Date).getFullYear();
            var godina = ""+currentYear;
            var YY = godina.substr(2,2);
            if(lastbroj.toString().length == 0) newbroj= prefix + '0001' + '/' + YY;
            if(lastbroj.toString().length == 1) newbroj= prefix + '000' + newbroj + '/' + YY;
            if(lastbroj.toString().length == 2) newbroj= prefix + '00' + newbroj + '/' + YY;
            if(lastbroj.toString().length == 3) newbroj= prefix + '0' + newbroj + '/' + YY;
            if(lastbroj.toString().length == 4) newbroj= prefix + newbroj + '/' + YY;
            jQuery('span.arhivskibroj').html(newbroj);
            jQuery('input.arhivskibroj').val(newbroj);
            jQuery('input.arhivskibrojint').val(newbrojint);
        }
    });
}
function izracunajkraendatum(){
    var rokDenovi=jQuery(".rokdenovi").val();
    if(rokDenovi)
    {
        var myDate=jQuery(".datum_zapis").val();
        myDate=myDate.split("-");
        var newDate=myDate[2]+","+myDate[1]+","+myDate[0];
        var novdatum=new Date(newDate).getTime()+(rokDenovi*86400 *1000 );
        var novdatumread=new Date(novdatum);
        jQuery(".rok").val(('0' + novdatumread.getDate()).slice(-2) +"-"+ ('0' + (novdatumread.getMonth()+1)).slice(-2)+"-"+novdatumread.getFullYear());
    }
    else jQuery(".rok").val('');
}
function if_izracunajkraendatum(){
    var rokDenovi=jQuery(".rokdenovi").val();
    if(rokDenovi)
    {
        var myDate=jQuery(".fakturadatum").val();
        myDate=myDate.split("-");
        var newDate=myDate[2]+","+myDate[1]+","+myDate[0];
        var novdatum=new Date(newDate).getTime()+(rokDenovi*86400 *1000 );
        var novdatumread=new Date(novdatum);
        jQuery(".rok").val(('0' + novdatumread.getDate()).slice(-2) +"-"+ ('0' + (novdatumread.getMonth()+1)).slice(-2)+"-"+novdatumread.getFullYear());
    }
    else jQuery(".rok").val('');
}
function pretvoriVoDatum2(timestamp){
    var datum = new Date(timestamp * 1000);
    var den = datum.getDate();
    var mesec = datum.getMonth() + 1*1;
    var godina = datum.getFullYear();
    if (den < 10)
        den = '0' + den;
    if (mesec < 10)
        mesec = '0' + mesec;
    if (godina < 10)
        godina = '0' + godina;
    var nov = den + "-" + mesec + "-" + godina;
//    var nov = godina + "-" + mesec + "-" + den;
    return nov;
}
function loadPregledFakturi() {
    var formaction = "/index.php/vlezni_fakturi/pregled_vlezni/menu";
    jQuery.ajax({
        url:formaction,
        success:function (response) {
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/pregled_vlezni/detalenPregled',
                type:'GET',
                success:function (response) {
                    jQuery("#detalenpregled").html(response);
                }
            });
            jQuery.ajax({
                url:'/index.php/vlezni_fakturi/pregled_vlezni/grupenPregled',
                type:'GET',
                success:function (response) {
                    jQuery("#grupenpregled").html(response);
                }
            });
            jQuery('.sub-menu-tabs').tabs({
                cache:true,
                ajaxOptions:{
                    type:"POST"
                }
            });
        }
    });
}function pecati_vf(faktura) {
//    var id = jQuery(".fakturaid").val();
//    var formaction = "/index.php/print/pdf?view=/index.php/vlezni_fakturi/faktura/print_vlezna_faktura&id="+faktura;
    var formaction = "/index.php/print/pdf/index";
    jQuery.ajax({
        url:formaction,
        type: "GET",
        data: { id:faktura, view: "/index.php/vlezni_fakturi/faktura/print_vlezna_faktura" },
        success:function (response) {
            console.log("print");
        }
    });
}
function autocomplete_vf_artikli()
{
    jQuery( ".vf-artikli" ).autocomplete({
        source: function( request, response ) {
            jQuery.ajax({
                url: "/index.php/vlezni_fakturi/faktura/autocomplete_vf_artikli",
                dataType: "jsonp",
                data: {
                    featureClass: "P",
                    style: "full",
                    maxRows: 25,
                    name_startsWith: request.term
                },
                success: function( data ) {
                    response( jQuery.map( data, function( item ) {
                        return {
                            label: item.S1Ime,
                            value: item.S1Ime,
                            id: item.SID
                        }
                    }));
                }
            });
        },
        minLength: 2,
        select: function( event, ui ) {
            var row = jQuery(this).closest("tr");
            var stavka = ui.item.id;
            getPodatociArtiklByStavka(stavka, row);
        },
        open: function() {
            jQuery( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
        },
        close: function() {
            jQuery( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
        }
    });
}
function autocomplete_vf_sifri()
{
    jQuery( ".vf-sifri" ).autocomplete({
        source: function( request, response ) {
            jQuery.ajax({
                url: "/index.php/vlezni_fakturi/faktura/autocomplete_vf_sifri",
                dataType: "jsonp",
                data: {
                    featureClass: "P",
                    style: "full",
                    maxRows: 25,
                    name_startsWith: request.term
                },
                success: function( data ) {
                    response( jQuery.map( data, function( item ) {
                        return {
                            label: item.sifra,
                            value: item.sifra,
                            id: item.SID
                        }
                    }));
                }
            });
        },
        minLength: 2,
        select: function( event, ui ) {
            var row = jQuery(this).closest("tr");
            var sifra = ui.item.value;
            getPodatociArtiklByKatBroj(sifra, row);
        },
        open: function() {
            jQuery( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
        },
        close: function() {
            jQuery( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
        }
    });
}
